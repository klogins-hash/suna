{
  "apiVersion": "v1",
  "spec": {
    "kind": "Workflow",
    "spec": {
      "type": "Deployment",
      "context": {
        "stack": "javascript",
        "language": "javascript"
      },
      "steps": [
        {
          "name": "redis",
          "spec": {
            "kind": "Addon",
            "spec": {
              "type": "redis",
              "version": "7.0",
              "replicas": 1,
              "typeOptions": {
                "storage": "1Gi"
              }
            }
          }
        },
        {
          "name": "backend",
          "spec": {
            "kind": "DeploymentService",
            "spec": {
              "deployment": {
                "docker": {
                  "configType": "dockerfile",
                  "pathToDockerfile": "./backend/Dockerfile"
                }
              },
              "runtimeEnvironment": {
                "ENV_MODE": "production",
                "DISABLE_AUTH": "true",
                "REDIS_HOST": "${redis.host}",
                "REDIS_PORT": "${redis.port}",
                "REDIS_PASSWORD": "${redis.password}",
                "REDIS_SSL": "false",
                "PORT": "8000"
              },
              "resources": {
                "cpu": "0.5",
                "memory": "1Gi",
                "replicas": {
                  "min": 1,
                  "max": 3
                }
              },
              "ports": [
                {
                  "name": "http",
                  "internalPort": 8000,
                  "public": true,
                  "protocol": "HTTP"
                }
              ]
            }
          }
        },
        {
          "name": "worker",
          "spec": {
            "kind": "DeploymentService", 
            "spec": {
              "deployment": {
                "docker": {
                  "configType": "dockerfile",
                  "pathToDockerfile": "./backend/Dockerfile"
                },
                "buildArguments": {},
                "dockerCommand": "uv run dramatiq --skip-logging --processes 2 --threads 2 run_agent_background"
              },
              "runtimeEnvironment": {
                "ENV_MODE": "production",
                "DISABLE_AUTH": "true", 
                "REDIS_HOST": "${redis.host}",
                "REDIS_PORT": "${redis.port}",
                "REDIS_PASSWORD": "${redis.password}",
                "REDIS_SSL": "false"
              },
              "resources": {
                "cpu": "0.5",
                "memory": "1Gi",
                "replicas": {
                  "min": 1,
                  "max": 2
                }
              }
            }
          }
        },
        {
          "name": "frontend",
          "spec": {
            "kind": "DeploymentService",
            "spec": {
              "deployment": {
                "docker": {
                  "configType": "dockerfile", 
                  "pathToDockerfile": "./frontend/Dockerfile"
                }
              },
              "runtimeEnvironment": {
                "NEXT_PUBLIC_DISABLE_AUTH": "true",
                "NEXT_PUBLIC_API_URL": "${backend.host}",
                "PORT": "3000"
              },
              "resources": {
                "cpu": "0.5",
                "memory": "1Gi",
                "replicas": {
                  "min": 1,
                  "max": 2
                }
              },
              "ports": [
                {
                  "name": "http",
                  "internalPort": 3000,
                  "public": true,
                  "protocol": "HTTP"
                }
              ]
            }
          }
        }
      ]
    }
  }
}
